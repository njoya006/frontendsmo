<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Owner Test - ChopSmo</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-title {
            color: #4CAF50;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #e8f5e9; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1565c0; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .dangerous {
            background: #f44336;
        }
        .dangerous:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-vial"></i> Recipe Ownership & CRUD Test</h1>
        <p>This page helps test the recipe ownership functionality, edit and delete features.</p>

        <div class="test-section">
            <h2 class="test-title">1. Authentication Status</h2>
            <button onclick="checkAuthStatus()">Check Auth Status</button>
            <div id="authResult" class="test-result info">Click button to check authentication</div>
        </div>

        <div class="test-section">
            <h2 class="test-title">2. Get Current User Profile</h2>
            <button onclick="getCurrentUser()">Get Current User</button>
            <div id="userResult" class="test-result info">Click button to get user profile</div>
        </div>

        <div class="test-section">
            <h2 class="test-title">3. Test Recipe Loading</h2>
            <label for="recipeIdInput">Recipe ID: </label>
            <input type="number" id="recipeIdInput" value="1" min="1">
            <button onclick="testRecipeLoad()">Load Recipe</button>
            <div id="recipeResult" class="test-result info">Click button to load recipe</div>
        </div>

        <div class="test-section">
            <h2 class="test-title">4. Test Ownership Check</h2>
            <button onclick="testOwnership()">Check Recipe Ownership</button>
            <div id="ownershipResult" class="test-result info">Click button to check ownership</div>
        </div>

        <div class="test-section">
            <h2 class="test-title">5. Test Recipe Update</h2>
            <input type="text" id="newTitle" placeholder="New recipe title" style="width: 300px; padding: 8px; margin: 5px;">
            <button onclick="testRecipeUpdate()">Update Recipe Title</button>
            <div id="updateResult" class="test-result info">Only works if you own the recipe</div>
        </div>

        <div class="test-section">
            <h2 class="test-title">6. Navigate to Recipe Detail</h2>
            <button onclick="goToRecipeDetail()">Go to Recipe Detail Page</button>
            <div id="navigationResult" class="test-result info">Opens recipe detail page with current recipe ID</div>
        </div>

        <div class="test-section">
            <h2 class="test-title">‚ö†Ô∏è Danger Zone</h2>
            <button class="dangerous" onclick="testRecipeDelete()">Delete Recipe (BE CAREFUL!)</button>
            <div id="deleteResult" class="test-result info">‚ö†Ô∏è This will actually delete the recipe if you're the owner!</div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script>
        let recipeAPI;
        let currentRecipe = null;
        let currentUser = null;

        // Initialize API
        document.addEventListener('DOMContentLoaded', function() {
            recipeAPI = new RecipeAPI();
            console.log('Recipe API initialized:', recipeAPI);
        });

        async function checkAuthStatus() {
            const result = document.getElementById('authResult');
            try {
                const token = recipeAPI.getAuthToken();
                if (token) {
                    result.className = 'test-result success';
                    result.innerHTML = `‚úÖ Auth token found: ${token.substring(0, 20)}...`;
                } else {
                    result.className = 'test-result info';
                    result.innerHTML = 'üîí No auth token found - using session auth';
                }
            } catch (error) {
                result.className = 'test-result error';
                result.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function getCurrentUser() {
            const result = document.getElementById('userResult');
            try {
                result.className = 'test-result info';
                result.innerHTML = 'üîÑ Loading user profile...';
                
                currentUser = await recipeAPI.getCurrentUser();
                result.className = 'test-result success';
                result.innerHTML = `‚úÖ User loaded: ${currentUser.username} (ID: ${currentUser.id})`;
            } catch (error) {
                result.className = 'test-result error';
                result.innerHTML = `‚ùå Error: ${error.message}`;
                currentUser = null;
            }
        }

        async function testRecipeLoad() {
            const result = document.getElementById('recipeResult');
            const recipeId = document.getElementById('recipeIdInput').value;
            
            try {
                result.className = 'test-result info';
                result.innerHTML = 'üîÑ Loading recipe...';
                
                currentRecipe = await recipeAPI.getRecipe(recipeId);
                result.className = 'test-result success';
                result.innerHTML = `‚úÖ Recipe loaded: "${currentRecipe.title}" by ${currentRecipe.contributor?.username || 'Unknown'}`;
            } catch (error) {
                result.className = 'test-result error';
                result.innerHTML = `‚ùå Error: ${error.message}`;
                currentRecipe = null;
            }
        }

        async function testOwnership() {
            const result = document.getElementById('ownershipResult');
            
            if (!currentRecipe) {
                result.className = 'test-result error';
                result.innerHTML = '‚ùå Load a recipe first';
                return;
            }

            if (!currentUser) {
                result.className = 'test-result error';
                result.innerHTML = '‚ùå Get current user first';
                return;
            }

            try {
                const isOwner = currentUser.username === currentRecipe.contributor?.username || 
                              currentUser.id === currentRecipe.contributor?.id ||
                              currentUser.is_verified_contributor ||
                              currentUser.is_staff;

                if (isOwner) {
                    result.className = 'test-result success';
                    result.innerHTML = `‚úÖ You OWN this recipe! You can edit/delete it.`;
                } else {
                    result.className = 'test-result info';
                    result.innerHTML = `üîí You DON'T own this recipe. Owner: ${currentRecipe.contributor?.username}`;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function testRecipeUpdate() {
            const result = document.getElementById('updateResult');
            const newTitle = document.getElementById('newTitle').value;
            const recipeId = document.getElementById('recipeIdInput').value;
            
            if (!newTitle) {
                result.className = 'test-result error';
                result.innerHTML = '‚ùå Enter a new title';
                return;
            }

            try {
                result.className = 'test-result info';
                result.innerHTML = 'üîÑ Updating recipe...';
                
                const updatedRecipe = await recipeAPI.updateRecipe(recipeId, { title: newTitle });
                result.className = 'test-result success';
                result.innerHTML = `‚úÖ Recipe updated! New title: "${updatedRecipe.title}"`;
                currentRecipe = updatedRecipe;
            } catch (error) {
                result.className = 'test-result error';
                result.innerHTML = `‚ùå Update failed: ${error.message}`;
            }
        }

        async function testRecipeDelete() {
            const result = document.getElementById('deleteResult');
            const recipeId = document.getElementById('recipeIdInput').value;
            
            if (!confirm(`‚ö†Ô∏è Are you SURE you want to delete recipe ID ${recipeId}? This cannot be undone!`)) {
                return;
            }

            try {
                result.className = 'test-result info';
                result.innerHTML = 'üîÑ Deleting recipe...';
                
                await recipeAPI.deleteRecipe(recipeId);
                result.className = 'test-result success';
                result.innerHTML = `‚úÖ Recipe deleted successfully!`;
                currentRecipe = null;
            } catch (error) {
                result.className = 'test-result error';
                result.innerHTML = `‚ùå Delete failed: ${error.message}`;
            }
        }

        function goToRecipeDetail() {
            const recipeId = document.getElementById('recipeIdInput').value;
            window.open(`recipe-detail.html?id=${recipeId}`, '_blank');
        }
    </script>
</body>
</html>
