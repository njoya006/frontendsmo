<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API Diagnostic Tool</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .error { background: #ffebee; border-color: #f44336; color: #c62828; }
        .success { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
        .warning { background: #fff3e0; border-color: #ff9800; color: #ef6c00; }
        .info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
        button { padding: 12px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #4caf50; color: white; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üõ†Ô∏è Backend API Diagnostic Tool</h1>
    <p>This tool helps diagnose why your backend is returning a <strong>500 Internal Server Error</strong></p>
    
    <div class="section error">
        <h2>‚ùå Current Problem</h2>
        <p><strong>HTTP 500 Internal Server Error</strong> from your backend API</p>
        <p>URL: <code>https://njoya.pythonanywhere.com/api/recipes/</code></p>
        <p>This means your backend server is running but has an internal error.</p>
    </div>

    <div class="section">
        <h2>üîç API Diagnostics</h2>
        <button class="btn-primary" onclick="testBasicConnection()">Test Basic Connection</button>
        <button class="btn-primary" onclick="testWithAuth()">Test With Auth Token</button>
        <button class="btn-primary" onclick="testOtherEndpoints()">Test Other Endpoints</button>
        <button class="btn-danger" onclick="clearResults()">Clear Results</button>
        <div id="diagnosticResults"></div>
    </div>

    <div class="section">
        <h2>üîß Troubleshooting Steps</h2>
        <ol>
            <li><strong>Check PythonAnywhere Error Logs:</strong>
                <ul>
                    <li>Go to your PythonAnywhere dashboard</li>
                    <li>Click on "Web" tab</li>
                    <li>Click on your domain (njoya.pythonanywhere.com)</li>
                    <li>Check "Error log" and "Server log"</li>
                    <li>Look for recent errors around the time you tested</li>
                </ul>
            </li>
            <li><strong>Common 500 Error Causes:</strong>
                <ul>
                    <li>Database not connected or migrated</li>
                    <li>Python syntax error in your API code</li>
                    <li>Missing required environment variables</li>
                    <li>Database authentication issues</li>
                    <li>Missing Python packages/dependencies</li>
                </ul>
            </li>
            <li><strong>Quick Fixes to Try:</strong>
                <ul>
                    <li>Restart your web app on PythonAnywhere</li>
                    <li>Run database migrations if using Django/Flask</li>
                    <li>Check if your database exists and has data</li>
                </ul>
            </li>
        </ol>
    </div>

    <div class="section info">
        <h2>üìã Next Steps</h2>
        <p>Once you fix the 500 error on your backend:</p>
        <ol>
            <li>Use the diagnostic tools above to verify the fix</li>
            <li>Refresh your Recipes page</li>
            <li>Your real database recipes should load automatically!</li>
        </ol>
    </div>

    <script>
        const resultsDiv = document.getElementById('diagnosticResults');
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }
        
        async function testBasicConnection() {
            appendResult('info', 'üîÑ Testing basic API connection...');
            
            try {
                const response = await fetch('https://njoya.pythonanywhere.com/api/recipes/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });
                
                appendResult('info', `üì° Response Status: ${response.status} ${response.statusText}`);
                appendResult('info', `üì° Response Headers: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}`);
                
                if (response.status === 500) {
                    appendResult('error', '‚ùå 500 Internal Server Error - Backend has an internal problem');
                    appendResult('warning', 'üîß Check your PythonAnywhere error logs immediately!');
                } else if (response.status === 404) {
                    appendResult('error', '‚ùå 404 Not Found - API endpoint does not exist');
                } else if (response.status === 403) {
                    appendResult('warning', '‚ö†Ô∏è 403 Forbidden - Authentication required');
                } else if (response.ok) {
                    const data = await response.json();
                    appendResult('success', `‚úÖ API Working! Found ${Array.isArray(data) ? data.length : 'unknown'} recipes`);
                    appendResult('info', `üìä Response Data: ${JSON.stringify(data, null, 2).substring(0, 500)}...`);
                } else {
                    appendResult('error', `‚ùå Unexpected status: ${response.status}`);
                }
                
            } catch (error) {
                appendResult('error', `‚ùå Network Error: ${error.message}`);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    appendResult('error', 'üîç This could be a CORS issue or server completely down');
                }
            }
        }
        
        async function testWithAuth() {
            const token = window.getAuthToken && window.getAuthToken();
                appendResult('info', `üîê Testing with auth token: ${token ? 'Present' : 'Not found'}`);
            
                if (!token) {
                    appendResult('warning', '‚ö†Ô∏è No auth token found - testing without authentication');
                    testBasicConnection();
                    return;
                }
            
                try {
                    const headers = window.authHeaders ? window.authHeaders({ 'Accept': 'application/json', 'Content-Type': 'application/json' }) : { 'Accept': 'application/json', 'Content-Type': 'application/json' };
                    const response = await fetch('https://njoya.pythonanywhere.com/api/recipes/', {
                        method: 'GET',
                        headers: headers,
                        mode: 'cors'
                    });
                
                appendResult('info', `üì° Auth Response Status: ${response.status} ${response.statusText}`);
                
                if (response.status === 401) {
                    appendResult('error', '‚ùå 401 Unauthorized - Invalid auth token');
                } else if (response.status === 500) {
                    appendResult('error', '‚ùå 500 Internal Server Error - Same issue with auth');
                } else if (response.ok) {
                    const data = await response.json();
                    appendResult('success', `‚úÖ Authenticated API Working! Found ${Array.isArray(data) ? data.length : 'unknown'} recipes`);
                }
                
            } catch (error) {
                appendResult('error', `‚ùå Auth Test Error: ${error.message}`);
            }
        }
        
        async function testOtherEndpoints() {
            const endpoints = [
                '/api/',
                '/api/recipes/1/',
                '/admin/',
                '/'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    appendResult('info', `üîç Testing endpoint: https://njoya.pythonanywhere.com${endpoint}`);
                    const response = await fetch(`https://njoya.pythonanywhere.com${endpoint}`, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    appendResult('info', `üì° ${endpoint}: ${response.status} ${response.statusText}`);
                } catch (error) {
                    appendResult('error', `‚ùå ${endpoint}: ${error.message}`);
                }
            }
        }
        
        function appendResult(type, message) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            setTimeout(testBasicConnection, 500);
        });
    </script>
</body>
</html>
