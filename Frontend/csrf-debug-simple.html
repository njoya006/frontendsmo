<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSRF Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç CSRF Debug Test</h1>
    
    <div>
        <button onclick="testStep1()">Step 1: Check Current State</button>
        <button onclick="testStep2()">Step 2: Test CSRF Endpoint</button>
        <button onclick="testStep3()">Step 3: Test Recipe API</button>
        <button onclick="testStep4()">Step 4: Test Manual Token</button>
        <button onclick="clearResults()">Clear</button>
    </div>

    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const logEntry = document.createElement('div');
            logEntry.className = `result ${type}`;
            logEntry.textContent = new Date().toLocaleTimeString() + ': ' + message;
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function testStep1() {
            log('=== STEP 1: CHECKING CURRENT STATE ===', 'info');
            log('Frontend URL: ' + window.location.origin, 'info');
            log('Backend URL: http://localhost:8000', 'info');
            log('Current cookies: ' + (document.cookie || 'NO COOKIES'), 'info');
            
            const csrfCookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
            if (csrfCookie) {
                log('CSRF cookie found: ' + csrfCookie.trim(), 'success');
            } else {
                log('NO CSRF cookie found', 'error');
            }
        }

        async function testStep2() {
            log('=== STEP 2: TESTING CSRF ENDPOINT ===', 'info');
            
            try {
                log('Requesting: GET http://localhost:8000/api/csrf-token/', 'info');
                const response = await fetch('http://localhost:8000/api/csrf-token/', {
                    method: 'GET',
                    credentials: 'include'
                });

                log('Response status: ' + response.status + ' ' + response.statusText, 
                    response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log('Response data: ' + JSON.stringify(data), 'success');
                    
                    if (data.csrfToken) {
                        log('CSRF token from endpoint: ' + data.csrfToken.substring(0, 20) + '...', 'success');
                    } else {
                        log('No csrfToken in response', 'error');
                    }
                } else {
                    const errorText = await response.text();
                    log('Error response: ' + errorText, 'error');
                }

                log('Cookies after CSRF endpoint: ' + (document.cookie || 'NO COOKIES'), 'info');

            } catch (error) {
                log('CSRF endpoint error: ' + error.message, 'error');
                log('This usually means the endpoint does not exist or CORS is not configured', 'error');
            }
        }

        async function testStep3() {
            log('=== STEP 3: TESTING RECIPE API ===', 'info');
            
            try {
                log('Requesting: GET http://localhost:8000/api/recipes/', 'info');
                const response = await fetch('http://localhost:8000/api/recipes/', {
                    method: 'GET',
                    credentials: 'include'
                });

                log('Response status: ' + response.status + ' ' + response.statusText, 
                    response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    const count = data.results ? data.results.length : data.length || 0;
                    log('Recipe API working: ' + count + ' recipes found', 'success');
                } else {
                    const errorText = await response.text();
                    log('Recipe API error: ' + errorText, 'error');
                }

                log('Cookies after recipe API: ' + (document.cookie || 'NO COOKIES'), 'info');

                // Check if CSRF cookie was set
                const csrfCookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
                if (csrfCookie) {
                    log('CSRF cookie found after recipe API: ' + csrfCookie.trim(), 'success');
                } else {
                    log('Still no CSRF cookie after recipe API', 'error');
                }

            } catch (error) {
                log('Recipe API error: ' + error.message, 'error');
            }
        }

        async function testStep4() {
            log('=== STEP 4: TESTING MANUAL TOKEN REQUEST ===', 'info');
            
            // Try to manually create CSRF token request
            try {
                log('Trying manual CSRF token request with session...', 'info');
                
                // First, try to get a session cookie
                const sessionResponse = await fetch('http://localhost:8000/api/recipes/1/', {
                    method: 'GET',
                    credentials: 'include'
                });

                log('Session request status: ' + sessionResponse.status, 'info');
                log('Cookies after session request: ' + (document.cookie || 'NO COOKIES'), 'info');

                // Try different CSRF endpoints
                const csrfEndpoints = [
                    '/api/csrf-token/',
                    '/csrf-token/',
                    '/api/csrf/',
                    '/csrf/'
                ];

                for (const endpoint of csrfEndpoints) {
                    try {
                        log('Trying endpoint: http://localhost:8000' + endpoint, 'info');
                        const response = await fetch('http://localhost:8000' + endpoint, {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const data = await response.json();
                            log('SUCCESS with endpoint ' + endpoint + ': ' + JSON.stringify(data), 'success');
                            break;
                        } else {
                            log('Failed with endpoint ' + endpoint + ': ' + response.status, 'warning');
                        }
                    } catch (error) {
                        log('Error with endpoint ' + endpoint + ': ' + error.message, 'warning');
                    }
                }

            } catch (error) {
                log('Manual token test error: ' + error.message, 'error');
            }
        }

        // Auto-run step 1 on load
        window.addEventListener('DOMContentLoaded', function() {
            testStep1();
            log('=== INSTRUCTIONS ===', 'info');
            log('1. Run Step 1 to check current state', 'info');
            log('2. Run Step 2 to test CSRF endpoint', 'info');
            log('3. Run Step 3 to test recipe API', 'info');
            log('4. If all fail, your Django backend needs configuration', 'info');
            log('', 'info');
            log('Required Django settings.py configuration:', 'warning');
            log('CSRF_TRUSTED_ORIGINS = ["http://127.0.0.1:5500"]', 'warning');
            log('CORS_ALLOWED_ORIGINS = ["http://127.0.0.1:5500"]', 'warning');
            log('', 'info');
            log('Required Django CSRF endpoint in urls.py:', 'warning');
            log('path("api/csrf-token/", csrf_token_view)', 'warning');
        });
    </script>
</body>
</html>
