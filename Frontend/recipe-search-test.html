<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Search Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .search-container { margin: 20px 0; }
        .search-input { width: 60%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; }
        .search-btn { padding: 12px 20px; font-size: 16px; background: #ff6b35; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px; }
        .search-btn:hover { background: #e55a2b; }
        .clear-btn { padding: 12px 20px; font-size: 16px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 5px; }
        .results { margin: 20px 0; }
        .recipe-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .recipe-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }
        .recipe-info { color: #666; font-size: 14px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .test-buttons { margin: 20px 0; }
        .test-btn { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Recipe Search Functionality Test</h1>
    
    <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search for recipes (e.g., chicken, pasta, curry)...">
        <button class="search-btn" onclick="testSearch()">üîç Search</button>
        <button class="clear-btn" onclick="clearResults()">Clear</button>
    </div>
    
    <div class="test-buttons">
        <h3>Quick Tests:</h3>
        <button class="test-btn" onclick="quickSearch('chicken')">Search "chicken"</button>
        <button class="test-btn" onclick="quickSearch('pasta')">Search "pasta"</button>
        <button class="test-btn" onclick="quickSearch('curry')">Search "curry"</button>
        <button class="test-btn" onclick="quickSearch('italian')">Search "italian"</button>
        <button class="test-btn" onclick="quickSearch('xyz123')">Search "xyz123" (no results)</button>
    </div>
    
    <div class="results" id="searchResults">
        <p>Enter a search term above to test the recipe search functionality.</p>
    </div>

    <script>
        let isLoggedIn = false;
        
        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            isLoggedIn = !!token;
            
            if (!isLoggedIn) {
                document.getElementById('searchResults').innerHTML = `
                    <div class="error">
                        <h3>‚ö†Ô∏è Authentication Required</h3>
                        <p>You need to be logged in to test recipe search. Please:</p>
                        <ol>
                            <li>Go to the <a href="Login.html">Login page</a></li>
                            <li>Log in with your credentials</li>
                            <li>Return to this page to test search</li>
                        </ol>
                    </div>
                `;
            }
            
            return isLoggedIn;
        }
        
        function getHeaders() {
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = token.startsWith('Token ') ? token : `Token ${token}`;
            }
            return headers;
        }
        
        async function testSearch() {
            if (!checkAuth()) return;
            
            const searchTerm = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '<div class="error">Please enter a search term.</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">üîç Searching recipes...</div>';
            
            try {
                // Test the exact same API call that Recipes.js uses
                const searchParams = new URLSearchParams();
                searchParams.append('search', searchTerm);
                searchParams.append('limit', '20');
                
                const response = await fetch(`https://njoya.pythonanywhere.com/api/recipes/?${searchParams.toString()}`, {
                    method: 'GET',
                    headers: getHeaders()
                });
                
                console.log('üîç Search response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìù Search response data:', data);
                
                const results = data.results || data;
                
                if (!Array.isArray(results)) {
                    throw new Error('Invalid response format: expected array of recipes');
                }
                
                displayResults(results, searchTerm);
                
            } catch (error) {
                console.error('‚ùå Search error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>Search Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please check:</p>
                        <ul>
                            <li>Your internet connection</li>
                            <li>That you're logged in</li>
                            <li>The API server is running</li>
                        </ul>
                    </div>
                `;
            }
        }
        
        function displayResults(results, searchTerm) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>No Results Found</h3>
                        <p>No recipes found for "<strong>${searchTerm}</strong>"</p>
                        <p>Try searching for:</p>
                        <ul>
                            <li>Common ingredients like "chicken", "rice", "tomato"</li>
                            <li>Recipe names like "curry", "pasta", "salad"</li>
                            <li>Cuisine types like "italian", "mexican", "indian"</li>
                        </ul>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="success">‚úÖ Found ${results.length} recipe(s) for "<strong>${searchTerm}</strong>"</div>`;
            
            results.forEach(recipe => {
                const title = recipe.title || recipe.name || 'Untitled Recipe';
                const description = recipe.description || 'No description available';
                const cuisine = recipe.cuisine || 'Not specified';
                const author = recipe.contributor?.username || recipe.author?.username || 'Unknown';
                const ingredients = recipe.ingredients ? recipe.ingredients.length : 'Unknown';
                
                html += `
                    <div class="recipe-card">
                        <div class="recipe-title">${title}</div>
                        <div class="recipe-info">
                            <p><strong>Description:</strong> ${description.substring(0, 150)}${description.length > 150 ? '...' : ''}</p>
                            <p><strong>Cuisine:</strong> ${cuisine} | <strong>By:</strong> ${author} | <strong>Ingredients:</strong> ${ingredients}</p>
                            <p><strong>ID:</strong> ${recipe.id}</p>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function quickSearch(term) {
            document.getElementById('searchInput').value = term;
            testSearch();
        }
        
        function clearResults() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '<p>Enter a search term above to test the recipe search functionality.</p>';
        }
        
        // Auto-check auth on page load
        window.addEventListener('load', checkAuth);
        
        // Allow Enter key to search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') testSearch();
        });
    </script>
</body>
</html>
