<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingredients Test - ChopSmo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .ingredients-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .ingredient-name {
            font-weight: 500;
            color: #333;
        }
        .ingredient-quantity {
            color: #666;
            font-size: 0.9em;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .test-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Ingredients Processing Test</h1>
        <p>This page tests the ingredient processing logic to ensure it works correctly.</p>
        
        <div class="test-section">
            <div class="test-title">Test Controls</div>
            <button class="test-button" onclick="testStandardFormat()">Test Standard Format</button>
            <button class="test-button" onclick="testDjangoFormat()">Test Django Format</button>
            <button class="test-button" onclick="testMixedFormat()">Test Mixed Format</button>
            <button class="test-button" onclick="testStringFormat()">Test String Format</button>
            <button class="test-button" onclick="clearResults()">Clear Results</button>
        </div>

        <div class="test-section">
            <div class="test-title">Rendered Ingredients</div>
            <ul class="ingredients-list" id="ingredientsList">
                <li class="ingredient-item">
                    <span class="ingredient-name">Click a test button to see ingredients</span>
                </li>
            </ul>
        </div>

        <div class="test-section">
            <div class="test-title">Debug Information</div>
            <pre id="debugInfo">Debug information will appear here</pre>
        </div>
    </div>

    <script>
        // Simulate the ingredient processing logic from recipe-detail.js
        class IngredientProcessor {
            constructor() {
                this.ingredientsList = document.getElementById('ingredientsList');
                this.debugInfo = document.getElementById('debugInfo');
            }

            renderIngredients(ingredients) {
                this.log('üçØ === INGREDIENTS RENDER DEBUG ===');
                this.log('Raw ingredients input:', ingredients);
                this.log('Type:', typeof ingredients);
                this.log('Is Array:', Array.isArray(ingredients));
                this.log('Length:', ingredients?.length);
                
                if (!ingredients) {
                    this.log('‚ùå No ingredients provided (null/undefined)');
                    this.ingredientsList.innerHTML = '<li class="ingredient-item"><span class="ingredient-name">No ingredients data received</span></li>';
                    return;
                }

                if (ingredients.length === 0) {
                    this.log('‚ùå Empty ingredients array');
                    this.ingredientsList.innerHTML = '<li class="ingredient-item"><span class="ingredient-name">No ingredients listed</span></li>';
                    return;
                }

                // Enhanced ingredient processing
                const ingredientItems = ingredients.map((ingredient, index) => {
                    this.log(`üîç Processing ingredient ${index + 1}:`, ingredient);
                    
                    let name, quantity;
                    
                    if (typeof ingredient === 'string') {
                        name = ingredient;
                        quantity = '';
                        this.log(`‚úÖ String ingredient: "${name}"`);
                    } else if (typeof ingredient === 'object' && ingredient !== null) {
                        this.log(`üîß Object ingredient keys:`, Object.keys(ingredient));
                        
                        // Enhanced name extraction - try multiple approaches
                        name = this.extractIngredientName(ingredient, index);
                        quantity = this.extractIngredientQuantity(ingredient);
                        
                        this.log(`‚úÖ Processed ingredient ${index + 1}:`, { name, quantity });
                    } else {
                        this.log(`‚ùå Unknown ingredient type:`, typeof ingredient, ingredient);
                        name = `Unknown ingredient ${index + 1}`;
                        quantity = '';
                    }

                    return `
                        <li class="ingredient-item">
                            <span class="ingredient-name">${name}</span>
                            ${quantity ? `<span class="ingredient-quantity">${quantity}</span>` : ''}
                        </li>
                    `;
                }).join('');

                this.log('üéØ Final ingredients HTML:', ingredientItems.substring(0, 200) + '...');
                this.ingredientsList.innerHTML = ingredientItems;
                this.log('üçØ === END INGREDIENTS RENDER DEBUG ===');
            }

            // Helper method to extract ingredient name from various possible formats
            extractIngredientName(ingredient, index) {
                // Try direct name fields first
                const directNameFields = [
                    'name', 'ingredient_name', 'title', 'item', 'display_name'
                ];
                
                for (const field of directNameFields) {
                    if (ingredient[field] && typeof ingredient[field] === 'string') {
                        this.log(`Found name in field '${field}': ${ingredient[field]}`);
                        return ingredient[field];
                    }
                }
                
                // Try nested ingredient object
                if (ingredient.ingredient && typeof ingredient.ingredient === 'object') {
                    this.log('Found nested ingredient object:', ingredient.ingredient);
                    
                    for (const field of directNameFields) {
                        if (ingredient.ingredient[field] && typeof ingredient.ingredient[field] === 'string') {
                            this.log(`Found name in nested field '${field}': ${ingredient.ingredient[field]}`);
                            return ingredient.ingredient[field];
                        }
                    }
                }
                
                // Try Django-style field names
                const djangoFields = [
                    'ingredient__name', 'ingredient__ingredient_name', 'ingredient__title'
                ];
                
                for (const field of djangoFields) {
                    if (ingredient[field] && typeof ingredient[field] === 'string') {
                        this.log(`Found name in Django field '${field}': ${ingredient[field]}`);
                        return ingredient[field];
                    }
                }
                
                // Last resort: look for any string field that might be the name
                const stringFields = Object.keys(ingredient).filter(key => 
                    typeof ingredient[key] === 'string' && 
                    ingredient[key].length > 0 &&
                    !['id', 'created_at', 'updated_at', 'recipe_id', 'recipe'].includes(key)
                );
                
                if (stringFields.length > 0) {
                    this.log(`Using fallback string field '${stringFields[0]}': ${ingredient[stringFields[0]]}`);
                    return ingredient[stringFields[0]];
                }
                
                // If all else fails, show object structure for debugging
                this.log(`‚ùå Could not extract name, showing object structure`);
                return `[DEBUG] ${JSON.stringify(ingredient)}`;
            }

            // Helper method to extract quantity information
            extractIngredientQuantity(ingredient) {
                const quantityFields = ['quantity', 'amount', 'qty', 'volume', 'weight', 'measure'];
                const unitFields = ['unit', 'units', 'measurement', 'unit_of_measurement', 'measure_unit'];
                
                let qty = '';
                let unit = '';
                
                // Find quantity
                for (const field of quantityFields) {
                    if (ingredient[field]) {
                        qty = ingredient[field];
                        break;
                    }
                }
                
                // Find unit
                for (const field of unitFields) {
                    if (ingredient[field]) {
                        unit = ingredient[field];
                        break;
                    }
                }
                
                if (qty && unit) {
                    return `${qty} ${unit}`;
                } else if (qty) {
                    return qty.toString();
                }
                
                return '';
            }

            log(...args) {
                console.log(...args);
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' ');
                    debugInfo.textContent += message + '\n';
                    debugInfo.scrollTop = debugInfo.scrollHeight;
                }
            }

            clearDebug() {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    debugInfo.textContent = '';
                }
            }
        }

        const processor = new IngredientProcessor();

        function clearResults() {
            processor.clearDebug();
            processor.ingredientsList.innerHTML = '<li class="ingredient-item"><span class="ingredient-name">Ready for testing</span></li>';
        }

        function testStandardFormat() {
            processor.clearDebug();
            processor.log('üß™ Testing Standard Format');
            
            const ingredients = [
                { ingredient_name: "Chicken breast", quantity: "500", unit: "g" },
                { ingredient_name: "Coconut milk", quantity: "400", unit: "ml" },
                { ingredient_name: "Onions", quantity: "2", unit: "medium" },
                { ingredient_name: "Garlic cloves", quantity: "4", unit: "pieces" }
            ];
            
            processor.renderIngredients(ingredients);
        }

        function testDjangoFormat() {
            processor.clearDebug();
            processor.log('üß™ Testing Django Nested Format');
            
            const ingredients = [
                { ingredient: { name: "Tomatoes", ingredient_name: "Fresh Tomatoes" }, quantity: 3, unit: "large" },
                { ingredient: { name: "Basil" }, amount: 2, units: "tbsp" },
                { ingredient__name: "Olive Oil", qty: 1, measurement: "tbsp" }
            ];
            
            processor.renderIngredients(ingredients);
        }

        function testMixedFormat() {
            processor.clearDebug();
            processor.log('üß™ Testing Mixed Formats');
            
            const ingredients = [
                { name: "Flour", quantity: 2, unit: "cups" },
                { title: "Sugar", amount: 1, units: "cup" },
                { item: "Eggs", qty: 3 },
                { display_name: "Butter", volume: 0.5, unit_of_measurement: "cup" }
            ];
            
            processor.renderIngredients(ingredients);
        }

        function testStringFormat() {
            processor.clearDebug();
            processor.log('üß™ Testing String Format');
            
            const ingredients = [
                "2 cups all-purpose flour",
                "1 tsp salt",
                "3 eggs",
                "1/2 cup milk"
            ];
            
            processor.renderIngredients(ingredients);
        }

        // Auto-run standard format test on page load
        window.addEventListener('load', function() {
            setTimeout(testStandardFormat, 1000);
        });
    </script>
</body>
</html>
