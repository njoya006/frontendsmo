<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChopSmo Recipes Page Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .diagnostic-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #2e7d32;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 10px;
        }
        .test-button {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .result {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #2e7d32; }
        .error { color: #d32f2f; }
        .warning { color: #f57c00; }
        .info { color: #1976d2; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background: #4caf50; }
        .status-error { background: #f44336; }
        .status-warning { background: #ff9800; }
    </style>
</head>
<body>
    <div class="diagnostic-container">
        <h1>üîß ChopSmo Recipes Page Diagnostic Tool</h1>
        <p>This tool will help diagnose and fix issues with the Recipes page, especially the Create Recipe button.</p>
    </div>

    <div class="diagnostic-container">
        <div class="section">
            <h2>üìä Page Status Check</h2>
            <button class="test-button" onclick="checkPageStatus()">Check Overall Page Status</button>
            <div id="pageStatusResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>üîê Authentication & Verification Tests</h2>
            <button class="test-button" onclick="checkAuthentication()">Check Authentication</button>
            <button class="test-button" onclick="testVerification()">Test Verification System</button>
            <button class="test-button" onclick="checkBackendConnection()">Test Backend Connection</button>
            <div id="authResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>üî≥ Create Recipe Button Tests</h2>
            <button class="test-button" onclick="checkButtonContainer()">Check Button Container</button>
            <button class="test-button" onclick="forceShowButton()">Force Show Button</button>
            <button class="test-button" onclick="testButtonFunctionality()">Test Button Click</button>
            <button class="test-button" onclick="reinitializeButton()">Re-initialize Button</button>
            <div id="buttonResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>üìú JavaScript Console Logs</h2>
            <button class="test-button" onclick="getConsoleLogs()">Get Recent Console Logs</button>
            <div id="consoleResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>üöÄ Quick Actions</h2>
            <button class="test-button" onclick="openRecipesPage()">Open Recipes Page</button>
            <button class="test-button" onclick="clearCache()">Clear Browser Cache</button>
            <button class="test-button" onclick="runFullDiagnostic()">Run Full Diagnostic</button>
        </div>
    </div>

    <script>
        let logHistory = [];
        
        // Override console.log to capture logs
        const originalLog = console.log;
        console.log = function(...args) {
            logHistory.push({
                timestamp: new Date().toISOString(),
                type: 'log',
                message: args.join(' ')
            });
            originalLog.apply(console, args);
        };

        function showResult(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.className = `result ${type}`;
            container.textContent = content;
        }

        async function checkPageStatus() {
            let status = "üîç RECIPES PAGE STATUS CHECK\n\n";
            
            // Check if we're on the recipes page
            if (window.location.pathname.includes('Recipes.html')) {
                status += "‚úÖ Currently on Recipes page\n";
            } else {
                status += "‚ùå Not on Recipes page\n";
            }
            
            // Check essential elements
            const elements = {
                'createRecipeButtonContainer': document.getElementById('createRecipeButtonContainer'),
                'recipesGrid': document.getElementById('recipesGrid'),
                'createRecipeModal': document.getElementById('createRecipeModal'),
                'recipeSearch': document.getElementById('recipeSearch')
            };
            
            for (const [name, element] of Object.entries(elements)) {
                if (element) {
                    status += `‚úÖ ${name} element found\n`;
                } else {
                    status += `‚ùå ${name} element missing\n`;
                }
            }
            
            // Check scripts
            const scripts = Array.from(document.scripts).map(s => s.src.split('/').pop()).filter(s => s);
            status += `\nüìú Loaded scripts: ${scripts.join(', ')}\n`;
            
            showResult('pageStatusResult', status);
        }

        async function checkAuthentication() {
            let result = "üîê AUTHENTICATION CHECK\n\n";
            
            // Check tokens
            const authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            if (authToken) {
                result += `‚úÖ Auth token found: ${authToken.substring(0, 20)}...\n`;
            } else {
                result += "‚ùå No auth token found\n";
            }
            
            // Try to get user profile
            try {
                const response = await fetch('https://njoya.pythonanywhere.com/api/users/profile/', {
                    headers: {
                        'Authorization': authToken ? (authToken.startsWith('Token ') ? authToken : `Token ${authToken}`) : '',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result += `‚úÖ Profile API call successful\n`;
                    result += `   Username: ${data.username || 'N/A'}\n`;
                    result += `   Email: ${data.email || 'N/A'}\n`;
                    result += `   Verified: ${data.is_verified || 'false'}\n`;
                    result += `   Staff: ${data.is_staff || 'false'}\n`;
                } else {
                    result += `‚ùå Profile API call failed: ${response.status}\n`;
                }
            } catch (error) {
                result += `‚ùå Profile API error: ${error.message}\n`;
            }
            
            showResult('authResult', result);
        }

        async function testVerification() {
            let result = "üß™ VERIFICATION SYSTEM TEST\n\n";
            
            // Check if verification functions exist
            if (typeof window.checkUserVerification === 'function') {
                result += "‚úÖ checkUserVerification function exists\n";
                try {
                    const verificationResult = await window.checkUserVerification();
                    result += `‚úÖ Verification check completed\n`;
                    result += `   Is Verified: ${verificationResult.isVerified}\n`;
                    result += `   Reason: ${verificationResult.reason}\n`;
                    result += `   Profile Data: ${JSON.stringify(verificationResult.profileData, null, 2)}\n`;
                } catch (error) {
                    result += `‚ùå Verification check failed: ${error.message}\n`;
                }
            } else {
                result += "‚ùå checkUserVerification function not found\n";
            }
            
            showResult('authResult', result);
        }

        async function checkBackendConnection() {
            let result = "üåê BACKEND CONNECTION TEST\n\n";
            
            try {
                const response = await fetch('https://njoya.pythonanywhere.com/api/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    result += "‚úÖ Backend is reachable\n";
                    result += `   Status: ${response.status}\n`;
                } else {
                    result += `‚ö†Ô∏è Backend returned status: ${response.status}\n`;
                }
            } catch (error) {
                result += `‚ùå Backend connection failed: ${error.message}\n`;
            }
            
            showResult('authResult', result);
        }

        function checkButtonContainer() {
            let result = "üî≥ CREATE RECIPE BUTTON CONTAINER CHECK\n\n";
            
            const container = document.getElementById('createRecipeButtonContainer');
            if (container) {
                result += "‚úÖ Container element found\n";
                result += `   Current content: ${container.innerHTML || '(empty)'}\n`;
                result += `   Display style: ${window.getComputedStyle(container).display}\n`;
                result += `   Visibility: ${window.getComputedStyle(container).visibility}\n`;
            } else {
                result += "‚ùå Container element not found\n";
            }
            
            showResult('buttonResult', result);
        }

        function forceShowButton() {
            let result = "üîß FORCING CREATE RECIPE BUTTON\n\n";
            
            const container = document.getElementById('createRecipeButtonContainer');
            if (container) {
                container.innerHTML = `
                    <div class="create-recipe-section" style="text-align: center;">
                        <button class="create-recipe-btn" id="createRecipeBtn">
                            <i class="fas fa-plus-circle"></i>
                            Create New Recipe
                        </button>
                    </div>
                `;
                
                // Add event listener
                const btn = document.getElementById('createRecipeBtn');
                if (btn) {
                    btn.addEventListener('click', () => {
                        const modal = document.getElementById('createRecipeModal');
                        if (modal) {
                            modal.style.display = 'block';
                            result += "‚úÖ Modal opened successfully\n";
                        }
                    });
                    result += "‚úÖ Button forced to show and event listener added\n";
                } else {
                    result += "‚ùå Failed to create button\n";
                }
            } else {
                result += "‚ùå Container not found\n";
            }
            
            showResult('buttonResult', result);
        }

        function testButtonFunctionality() {
            let result = "üß™ BUTTON FUNCTIONALITY TEST\n\n";
            
            const button = document.getElementById('createRecipeBtn');
            if (button) {
                result += "‚úÖ Button element found\n";
                
                // Test click
                try {
                    button.click();
                    result += "‚úÖ Button click triggered\n";
                    
                    // Check if modal opened
                    const modal = document.getElementById('createRecipeModal');
                    if (modal && modal.style.display === 'block') {
                        result += "‚úÖ Modal opened successfully\n";
                        modal.style.display = 'none'; // Close it
                    } else {
                        result += "‚ùå Modal did not open\n";
                    }
                } catch (error) {
                    result += `‚ùå Button click failed: ${error.message}\n`;
                }
            } else {
                result += "‚ùå Button element not found\n";
            }
            
            showResult('buttonResult', result);
        }

        async function reinitializeButton() {
            let result = "üîÑ RE-INITIALIZING BUTTON\n\n";
            
            if (typeof window.initializeCreateRecipeButton === 'function') {
                try {
                    await window.initializeCreateRecipeButton();
                    result += "‚úÖ Button reinitialization completed\n";
                    
                    const container = document.getElementById('createRecipeButtonContainer');
                    result += `   New content: ${container?.innerHTML || '(empty)'}\n`;
                } catch (error) {
                    result += `‚ùå Reinitialization failed: ${error.message}\n`;
                }
            } else {
                result += "‚ùå initializeCreateRecipeButton function not found\n";
            }
            
            showResult('buttonResult', result);
        }

        function getConsoleLogs() {
            let result = "üìú RECENT CONSOLE LOGS\n\n";
            
            const recentLogs = logHistory.slice(-20); // Last 20 logs
            if (recentLogs.length > 0) {
                recentLogs.forEach(log => {
                    result += `[${log.timestamp}] ${log.message}\n`;
                });
            } else {
                result += "No recent logs captured\n";
            }
            
            showResult('consoleResult', result);
        }

        function openRecipesPage() {
            if (!window.location.pathname.includes('Recipes.html')) {
                window.location.href = 'Recipes.html';
            } else {
                window.location.reload();
            }
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            showResult('consoleResult', "‚úÖ Browser cache cleared\n\nPlease refresh the page to reload scripts.");
        }

        async function runFullDiagnostic() {
            await checkPageStatus();
            await checkAuthentication();
            await testVerification();
            await checkBackendConnection();
            checkButtonContainer();
        }
    </script>
</body>
</html>
